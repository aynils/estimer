{% extends 'layout/base.html' %}
{% load static %}

{% block headscript %}
    <title>{{ title }}</title>
    <meta name="description"
          content="Découvrez les prix du m2 à {{ city_name }} et l’évolution du marché de l’immobilier
           dans votre ville, puis obtenez l’estimation de votre maison ou appartement."/>

    {#    Mapbox#}


    <link rel="stylesheet" type="text/css" href="{% static 'estimer/css/city.css' %}">
{% endblock %}

{% block body %}
    <div class="section-7">


        <div class="columns-13 w-row">
            <div class="column-9 w-col w-col-6">

                <div class="column-12 w-col">
                    <h1 class="heading-4">Prix au m2 à
                        {{ city_name }}</h1>
                    <div class="div-block-35"></div>
                    <div class="text-block-29">Suite à l’analyse des {{ city_data.number_of_sales }}
                        transactions immobilières à {{ city_name }},
                        en 2021,
                        nous observons un prix au m2 de {{ city_data.median_m2_price_appartement.value }} € pour les
                        appartements,
                        et de {{ city_data.median_m2_price_maison.value }} € pour les maisons.
                    </div>
                    <div class="div-block-30 ">
                        <div class="columns-12 w-row">
                            <div class="w-col w-col-6"><img
                                    src="{% static 'estimer/images/5ff4e2b0c5090619d5965a09_appartement.svg' %}"
                                    loading="lazy" alt="appartement" class="image-6">
                                <div class="text-block-25">Appartement</div>
                            </div>
                            <div class="w-col w-col-6">
                                <div class="text-block-26">Prix m2 moyen en 2021</div>
                                <div class="text-block-28">{{ city_data.median_m2_price_appartement.value }} €</div>
                                {% if city_data.median_m2_price_appartement_rooms.four %}
                                    <div class="div-block-22">
                                        <span>4 pièces</span>
                                        <span style="float: right;">{{ city_data.median_m2_price_appartement_rooms.four }} € m2</span>
                                    </div>
                                {% endif %}
                                {% if city_data.median_m2_price_appartement_rooms.three %}
                                    <div class="div-block-22">
                                        <span>3 pièces</span>
                                        <span style="float: right;">{{ city_data.median_m2_price_appartement_rooms.three }} € m2</span>
                                    </div>
                                {% endif %}
                                {% if city_data.median_m2_price_appartement_rooms.two %}
                                    <div class="div-block-22">
                                        <span>2 pièces</span>
                                        <span style="float: right;">{{ city_data.median_m2_price_appartement_rooms.two }} € m2</span>
                                    </div>
                                {% endif %}
                                {% if city_data.median_m2_price_appartement_rooms.one %}
                                    <div class="div-block-22">
                                        <span>1 pièce</span>
                                        <span style="float: right;">{{ city_data.median_m2_price_appartement_rooms.one }} € m2</span>
                                    </div>
                                {% endif %}

                            </div>
                        </div>
                        <div class="div-block-31"></div>
                        <div class="columns-12 w-row">
                            <div class="w-col w-col-6"><img
                                    src="{% static 'estimer/images/5ff4e2bcf745434ac10876ea_home.svg' %}"
                                    loading="lazy" alt="maison" class="image-6">
                                <div class="text-block-25">Maison</div>
                            </div>
                            <div class="w-col w-col-6">
                                <div class="text-block-26">Prix m2 moyen en 2021</div>
                                <div class="text-block-28">{{ city_data.median_m2_price_maison.value }} €</div>

                                {% if city_data.median_m2_price_maison_rooms.four %}
                                    <div class="div-block-22">
                                        <span>4 pièces</span>
                                        <span style="float: right;">{{ city_data.median_m2_price_maison_rooms.four }} € m2</span>
                                    </div>
                                {% endif %}
                                {% if city_data.median_m2_price_maison_rooms.three %}
                                    <div class="div-block-22">
                                        <span>3 pièces</span>
                                        <span style="float: right;">{{ city_data.median_m2_price_maison_rooms.three }} € m2</span>
                                    </div>
                                {% endif %}
                                {% if city_data.median_m2_price_maison_rooms.two %}
                                    <div class="div-block-22">
                                        <span>2 pièces</span>
                                        <span style="float: right;">{{ city_data.median_m2_price_maison_rooms.two }} € m2</span>
                                    </div>
                                {% endif %}
                                {% if city_data.median_m2_price_maison_rooms.one %}
                                    <div class="div-block-22">
                                        <span>1 pièces</span>
                                        <span style="float: right;">{{ city_data.median_m2_price_maison_rooms.one }} € m2</span>
                                    </div>
                                {% endif %}
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="column-12 w-col w-col-6 ">
                <h2 class="heading-historique">Évolution du prix du m2 moyen
                    à {{ city_name }}</h2>
                <div class="div-block-35"></div>
                <div class="text-block-29">
                    {{ city_data.price_evolution_text }}
                </div>
                <div class="columns-14 w-row">
                    <div class="div-block-34">
                        <img
                                src='data:image/svg+xml;base64,{{ city_data.chart_b64_svg }}'
                                alt="prix m2 {{ city_name }}"
                        >
                    </div>
                </div>

                <div class="div-block-26">
                    <div>
                        <img alt="photo de {{ city_data.agent.name }}" class="agent-img"
                             src="{{ city_data.agent.picture }}"/>
                    </div>
                    <div class="text-block-18">{{ city_data.agent.name }}</div>
                    <div class="text-block-19">{{ city_data.agent.agence }}</div>
                    <div class="text-block-20 ">{{ city_data.agent.description }}
                    </div>
                    <div class="text-block-21">Contact</div>
                    <div class="text-block-20">{{ city_data.agent.phoneNumber }}</div>
                    <div class="text-block-20">{{ city_data.agent.email }}</div>
                    <div class="text-block-20">{{ city_data.agent.website }}</div>
                </div>
            </div>
        </div>
    </div>


    <div class="section-7">
        <div class="columns-14 w-row">


            <div class="w-col w-col-6 "><h3 class="heading-historique">Rues les
                plus chères à
                {{ city_name }}</h3>
                <div class="div-block-43"></div>
                <div class="div-block-42">
                    <div class="div-block-45">
                        {% for street in city_data.most_expensive_streets %}
                            <div class="div-block-22">
                <span
                        class="capitalize">{{ street.nom_voie }}</span>
                                <span style="float: right;">{{ street.avg_m2_price }} € m2</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="column-10  w-col w-col-6 "><h3 class="heading-historique">Rues les moins chères
                à
                {{ city_name }}</h3>
                <div class="div-block-43"></div>
                <div class="div-block-42">
                    <div class="div-block-45">
                        {% for street in city_data.less_expensive_streets %}
                            <div class="div-block-22">
                                <span class="capitalize">{{ street.nom_voie }}</span>
                                <span style="float: right;">{{ street.avg_m2_price }} € m2</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="section-7">

        <h2 class="heading-historique">Dernières transactions
            immobilières à {{ city_name }}</h2>
        <div class="div-block-35"></div>


        <div class="map-container">
            {% include 'map/map.html' %}
        </div>
    </div>
    <div class="section-7">

        <h2 class="heading-historique">Communes à proximité de {{ city_name }}</h2>
        <div class="div-block-35"></div>

        <div class="links-container">
            <div class="w-col w-col-6">
                {% for city in closeby_cities|slice:":10" %}
                    <div class="city-link">
                        <a href="/commune/{{ city.slug }}">{{ city.nom_commune }}</a>
                    </div>
                {% endfor %}
            </div>
            <div class="w-col w-col-6">
                {% for city in closeby_cities|slice:"10:20" %}
                    <div class="city-link">
                        <a href="/commune/{{ city.slug }}">{{ city.nom_commune }}</a>
                    </div>
                {% endfor %}
            </div>
            <div class="w-col w-col-6">
                {% for city in closeby_cities|slice:"20:30" %}
                    <div class="city-link">
                        <a href="/commune/{{ city.slug }}">{{ city.nom_commune }}</a>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}

{% block endscript %}
    <script  src='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.js'></script>
    <link async defer href='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.css' rel='stylesheet'/>
    <script async defer>
        let lastSales = {
            "type": "FeatureCollection",
            "features": JSON.parse('{{ map_markers | escapejs }}')

        };

        mapboxgl.accessToken = `{{ MAPBOX_PUBLIC_TOKEN }}`;
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v10?optimize=true',
            center: [2.213749, 46.227638],
            zoom: 4,
        });

        const coordinates = lastSales.features.map(feature => feature.geometry.coordinates)

        const bounds = coordinates.reduce(function (bounds, coord) {
            return bounds.extend(coord);
        }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));

        lastSales.features.forEach(function (sale, i) {
            sale.properties.id = i;
        });

        map.on('load', function (e) {
            /* Add the data to your map as a layer */
            map.addSource('places', {
                'type': 'geojson',
                'data': lastSales
            });

            /**
             * Add all the things to the page:
             * - The location listings on the side of the page
             * - The markers onto the map
             */
            buildLocationList(lastSales);
            addMarkers();

            map.fitBounds(bounds, {padding: 20});
        });

        function addMarkers() {
            /* For each feature in the GeoJSON object above: */
            lastSales.features.forEach(function (marker) {

                /* Create a div element for the marker. */
                var el = document.createElement('div');
                /* Assign a unique `id` to the marker. */
                el.id = 'marker-' + marker.properties.id;
                /* Assign the `marker` class to each marker for styling. */
                el.className = 'marker';

                /**
                 * Create a marker using the div element
                 * defined above and add it to the map.
                 **/
                new mapboxgl.Marker(el, {offset: [0, -23]})
                    .setLngLat(marker.geometry.coordinates)
                    .addTo(map);

                /**
                 * Listen to the element and when it is clicked, do three things:
                 * 1. Fly to the point
                 * 2. Close all other popups and display popup for clicked store
                 * 3. Highlight listing in sidebar (and remove highlight for all other listings)
                 **/
                el.addEventListener('click', function (e) {
                    /* Fly to the point */
                    flyToStore(marker);
                    /* Close all other popups and display popup for clicked store */
                    createPopUp(marker);
                    /* Highlight listing in sidebar */
                    var activeItem = document.getElementsByClassName('active');
                    e.stopPropagation();
                    if (activeItem[0]) {
                        activeItem[0].classList.remove('active');
                    }
                    var listing = document.getElementById(
                        'listing-' + marker.properties.id
                    );
                    listing.classList.add('active');
                });

            });
        }

        /**
         * Add a listing for each store to the sidebar.
         **/
        function buildLocationList(data) {
            data.features.forEach(function (sale, i) {
                /**
                 * Create a shortcut for `store.properties`,
                 * which will be used several times below.
                 **/
                var prop = sale.properties;

                /* Add a new listing section to the sidebar. */
                var listings = document.getElementById('listings');
                var listing = listings.appendChild(document.createElement('div'));
                /* Assign a unique `id` to the listing. */
                listing.id = 'listing-' + prop.id;
                /* Assign the `item` class to each listing for styling. */
                listing.className = 'item';

                /* Add the link to the individual listing created above. */
                const link = listing.appendChild(document.createElement('a'));
                link.href = '#';
                link.className = 'title';
                link.id = 'link-' + prop.id;
                link.innerHTML = prop.address.nom_voie + ' ' + (prop.address.numero_voie || '');

                /* Add details to the individual listing. */
                const details = listing.appendChild(document.createElement('div'));
                details.innerHTML = prop.type_local;
                if (prop.rooms_count) {
                    details.innerHTML += ' &middot; ' + prop.rooms_count + (prop.rooms_count >1 ? ' pièces' : ' pièce');
                }

                /**
                 * Listen to the element and when it is clicked, do four things:
                 * 1. Update the `currentFeature` to the store associated with the clicked link
                 * 2. Fly to the point
                 * 3. Close all other popups and display popup for clicked store
                 * 4. Highlight listing in sidebar (and remove highlight for all other listings)
                 **/
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    for (var i = 0; i < data.features.length; i++) {
                        if (this.id === 'link-' + data.features[i].properties.id) {
                            var clickedListing = data.features[i];
                            flyToStore(clickedListing);
                            createPopUp(clickedListing);
                        }
                    }
                    var activeItem = document.getElementsByClassName('active');
                    if (activeItem[0]) {
                        activeItem[0].classList.remove('active');
                    }
                    this.parentNode.classList.add('active');
                });
            });
        }

        /**
         * Use Mapbox GL JS's `flyTo` to move the camera smoothly
         * a given center point.
         **/
        function flyToStore(currentFeature) {
            map.flyTo({
                center: currentFeature.geometry.coordinates,
                zoom: 15
            });
        }

        /**
         * Create a Mapbox GL JS `Popup`.
         **/
        function createPopUp(currentFeature) {
            var popUps = document.getElementsByClassName('mapboxgl-popup');
            if (popUps[0]) popUps[0].remove();
            var popup = new mapboxgl.Popup({closeOnClick: false})
                .setLngLat(currentFeature.geometry.coordinates)
                .setHTML(
                    `
                <h3> ${currentFeature.properties.address.nom_voie} ${currentFeature.properties.address.numero || ''} ${currentFeature.properties.address.suffixe || ''}</h3>
                <table class="popup-table">
                  <tr>
                    <td class="col-1">Prix de vente</td>
                    <td class="col-2">${currentFeature.properties.price} €</td>
                  </tr>
                <tr>
                    <td class="col-1">Superficie</td>
                    <td class="col-2">${currentFeature.properties.surface} m2</td>
                  </tr>
                <tr>
                    <td class="col-1">Prix au m2</td>
                    <td class="col-2">${currentFeature.properties.m2_price} €</td>
                  </tr>
                <tr>
                    <td class="col-1">Date de vente</td>
                    <td class="col-2">${currentFeature.properties.date}</td>
                  </tr>
                </table>
                `
                )
                .addTo(map);
        }

    </script>
{% endblock %}
