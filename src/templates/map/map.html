{% load static %}
{#<link rel="stylesheet" type="text/css" href="{% static 'estimer/css/map.css' %}">#}
<div id="map" class="md:w-[1000px] h-[600px] mx-auto"></div>

<script src='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.css' rel='stylesheet'/>

<script async defer>
    let neighbourhoods = {
        "type": "FeatureCollection",
        "features": JSON.parse('{{ neighbourhoods | escapejs }}'),

    };

    mapboxgl.accessToken = `{{ MAPBOX_PUBLIC_TOKEN }}`;
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v10?optimize=true',
        center: [5.05525, 45.33675], // default values. Will be overridden by fitBounds
        zoom: 14, // default value. Will be overridden by fitBounds
    });

    const coordinates = neighbourhoods.features.map(feature => feature.geometry.coordinates)
    const allCoordinates = coordinates.flat(3)
    const firstPoint = {
        lng: allCoordinates[0][0],
        lat: allCoordinates[0][1],
    }


    const bounds = allCoordinates.reduce((bounds, coord) => {
            return bounds.extend(coord);
        }
        , new mapboxgl.LngLatBounds()
    );


    map.on('load', function (e) {
        /* Add the data to your map as a layer */
        neighbourhoods.features.forEach(feature =>
            map.addSource(feature.properties.code_iris, {
                'type': 'geojson',
                'data': feature
            })
        );

        neighbourhoods.features.forEach(feature => {
                map.addLayer({
                    'id': `${feature.properties.code_iris}-fill`,
                    'type': 'fill',
                    'source': feature.properties.code_iris,
                    'layout': {},
                    'paint': {
                        'fill-color': feature.properties.color.background,
                        'fill-opacity': 0.5
                    }
                })

                {# Keep this part usefull for debugging: displays borders when uncommented#}
                {#map.addLayer({#}
                {#    'id': `${feature.properties.code_iris}-outline`,#}
                {#    'type': 'line',#}
                {#    'source': feature.properties.code_iris,#}
                {#    'layout': {},#}
                {#    'paint': {#}
                {#        'line-color': feature.properties.color.background,#}
                {#        'line-width': 2,#}
                {#    }}#}
                {#    );#}

            {# Duplicated labels because of this: https://github.com/mapbox/mapbox-gl-js/issues/5583#issuecomment-341840524#}
                map.addLayer({
                    'id': `${feature.properties.code_iris}-label`,
                    'type': 'symbol',
                    'source': feature.properties.code_iris,
                    'layout': {
                        'text-field': ['get', 'average_m2_price'],
                        'text-font': ['Montserrat Bold']
                    },
                    'paint':{
                        'text-color': feature.properties.color.text,
                    }
                });
            }
        );


        map.fitBounds(bounds, {padding: 20, duration: 0});
    });

    /**
     * Use Mapbox GL JS's `flyTo` to move the camera smoothly
     * a given center point.
     **/
    function flyToFeature(currentFeature) {
        map.flyTo({
            center: currentFeature.geometry.coordinates,
            zoom: 15
        });
    }

</script>
